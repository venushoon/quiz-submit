<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>실시간 퀴즈 (관리자 · 학생)</title>
<style>
  :root{
    --bg:#0b1220;--panel:#111827;--panel2:#0f172a;--border:#1f2937;
    --text:#e5e7eb;--muted:#9ca3af;
    --primary:#6366f1;--primary2:#4f46e5;--accent:#22d3ee;
    --ok:#10b981;--no:#ef4444;--warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:17px/1.6 "Noto Sans KR",system-ui,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  h1{font-size:36px;margin:12px 0}
  .row{display:flex;align-items:center;gap:12px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .hidden{display:none!important}
  .muted{color:var(--muted)}
  input,button,textarea{font:inherit;color:inherit}
  input[type=text],input[type=number],textarea{
    background:var(--panel2);border:1px solid var(--border);color:var(--text);
    border-radius:12px;padding:12px 16px;font-size:16px;width:100%;
  }
  input:focus,textarea:focus{outline:2px solid var(--accent)}
  .btn{background:var(--primary);color:#fff;border:0;border-radius:12px;padding:12px 20px;font-size:16px;cursor:pointer;transition:.15s}
  .btn:hover{background:var(--primary2)}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.small{padding:8px 14px;font-size:14px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px}
  .badge{display:inline-flex;align-items:center;background:#171f34;border:1px solid #223052;color:#f87171;padding:6px 14px;border-radius:24px;font-size:14px}
  .badge .dot{width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 0 5px #ef44441f;margin-right:8px}
  .tabbar{display:flex;gap:8px;margin-bottom:10px}
  .tab{padding:10px 16px;border-radius:10px;cursor:pointer;background:var(--panel2);color:var(--muted);font-size:15px;border:1px solid var(--border)}
  .tab.active{background:#1a223a;color:#fff}
  .option{display:block;width:100%;background:#0e162b;border:1px solid var(--border);padding:14px;border-radius:12px;cursor:pointer;font-size:16px}
  .option:hover{background:#0c1426}
  .option.selected{border-color:var(--accent)}
  .option.correct{background:#05251a;border-color:#0c7a55}
  .option.wrong{background:#2a0d0d;border-color:#b91c1c}
  .chip{display:inline-block;padding:6px 12px;margin:4px;background:#1f2937;border-radius:20px;font-size:14px}
  .chip.ok{border:1px solid #065f46}
  .chip.no{border:1px solid #7f1d1d}
  .timer{font-variant-numeric:tabular-nums;font-weight:700;letter-spacing:.5px;font-size:18px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px;text-align:center}
  th{background:#0f1527}
  .banner{margin:10px 0;padding:12px;border:1px dashed var(--warn);border-radius:12px;color:#fcd34d;font-size:15px}
</style>

<!-- Firebase v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- QRCode -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
<div class="wrap">
  <div id="banner" class="banner hidden"></div>

  <div class="row">
    <span class="badge"><span class="dot"></span>LIVE</span>
    <div class="row" style="margin-left:auto;gap:10px">
      <label class="muted">세션 코드</label>
      <input id="roomIdInput" placeholder="예: classA" style="width:220px"/>
      <button id="btnConnect" class="btn">접속</button>
      <button id="btnTeacherMode" class="btn ghost">관리자</button>
      <button id="btnStudentMode" class="btn ghost">학생</button>
    </div>
  </div>

  <h1>실시간 퀴즈</h1>
  <div id="statusText" class="muted">세션에 접속해 주세요.</div>

  <!-- 학생: 참가 -->
  <div id="joinCard" class="panel row" style="margin-top:16px">
    <input id="studentName" placeholder="이름 또는 번호" style="max-width:320px"/>
    <button id="btnJoin" class="btn">참가</button>
  </div>

  <!-- 학생: 퀴즈 -->
  <div id="studentQuiz" class="panel hidden" style="margin-top:16px">
    <div class="row">
      <span id="quizTypeBadge" class="badge">대기</span>
      <div id="progressText" class="muted">0 / 0</div>
      <div class="row" style="margin-left:auto">
        <span class="muted">남은 시간</span>
        <span id="countdown" class="timer">00:00</span>
      </div>
    </div>
    <h3 id="questionText">대기 중입니다…</h3>
    <div id="optionsContainer" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
    <div id="subjectiveBox" class="hidden row" style="margin-top:10px">
      <input id="subjectiveInput" placeholder="정답 입력" style="max-width:320px"/>
      <button id="btnSubmitSubjective" class="btn">제출</button>
    </div>
    <div id="answerState" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 관리자 -->
  <div id="teacherPanel" class="hidden" style="margin-top:20px">
    <div class="tabbar">
      <button class="tab active" data-tab="build">문항 만들기</button>
      <button class="tab" data-tab="control">진행</button>
      <button class="tab" data-tab="results">결과</button>
    </div>

    <!-- 문항 만들기 -->
    <section id="tab-build" class="panel">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <input id="quizTitle" placeholder="퀴즈 제목" style="flex:1;min-width:240px"/>
        <label>문항 수</label>
        <input id="questionCount" type="number" min="1" max="20" value="3" style="width:110px"/>
        <button id="btnBuildForm" class="btn">폼 만들기</button>
        <button id="btnLoadSample" class="btn ghost">샘플 불러오기</button>
        <button id="btnSaveQuiz" class="btn">퀴즈 저장</button>
      </div>
      <div id="builder" style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px"></div>
    </section>

    <!-- 진행 -->
    <section id="tab-control" class="panel hidden">
      <div class="grid-2">
        <div class="panel">
          <div class="row" style="flex-wrap:wrap;gap:10px">
            <button id="btnStart" class="btn">시작</button>
            <button id="btnPrev" class="btn ghost">이전</button>
            <button id="btnNext" class="btn">다음</button>
            <button id="btnStop" class="btn ghost">종료</button>
            <label class="row"><input id="toggleAccept" type="checkbox" style="margin-right:6px"/>제출 허용</label>
            <label class="row"><input id="toggleReveal" type="checkbox" style="margin-right:6px"/>결과 공개</label>
            <div class="row" style="margin-left:auto">현재: <span id="ctlQuestion">-</span></div>
          </div>
          <div class="row" style="margin-top:12px;flex-wrap:wrap;gap:10px">
            <label>타이머(초)</label>
            <input id="timerSec" type="number" min="5" value="30" style="width:120px"/>
            <button id="btnTimerStart" class="btn small">타이머 시작</button>
            <button id="btnTimerStop" class="btn ghost small">정지</button>
            <div class="row" style="margin-left:auto">
              <span class="muted">남은 시간</span>
              <span id="teacherCountdown" class="timer">00:00</span>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="row" style="align-items:flex-start;gap:16px">
            <canvas id="qrCanvas" width="160" height="160" style="background:#fff;border-radius:8px"></canvas>
            <div style="flex:1">
              <label class="muted">학생용 링크</label>
              <input id="studentLink" readonly/>
              <div class="row" style="margin-top:8px">
                <button id="btnCopyLink" class="btn small">링크 복사</button>
                <button id="btnOpenStudent" class="btn ghost small">학생 모드로 열기</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="muted">제출자</div>
        <div id="chips" style="margin-top:6px"></div>
      </div>

      <div id="shortGrader" class="panel hidden" style="margin-top:12px">
        <div class="muted">주관식 채점</div>
        <div id="shortAnswers" style="margin-top:8px;display:grid;grid-template-columns:1fr;gap:8px"></div>
      </div>
    </section>

    <!-- 결과 -->
    <section id="tab-results" class="panel hidden">
      <div class="grid-2">
        <div class="panel">
          <div class="row" style="gap:10px">
            <button id="btnExportCSV" class="btn">CSV 내보내기</button>
          </div>
          <div id="resultsContainer" class="panel" style="margin-top:12px"></div>
        </div>
        <div class="panel">
          <div class="row">
            <h3 style="margin:0">리더보드 (상위 10)</h3>
            <button id="btnRefreshLeaderboard" class="btn small" style="margin-left:auto">새로고침</button>
          </div>
          <div id="leaderboard" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
/* ============== Firebase 초기화 ============== */
const firebaseConfig = {
  apiKey: "AIzaSyCClNc95ykYCudmLHTPgpewZ60bZ8zukbo",
  authDomain: "live-quiz-a14d1.firebaseapp.com",
  projectId: "live-quiz-a14d1",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============== 공통 유틸 ============== */
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s));
const banner=qs('#banner');
const showBanner=(m)=>{banner.textContent=m;banner.classList.remove('hidden')}
const hideBanner=()=>banner.classList.add('hidden');
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const escapeHtml=(s='')=>s.replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const escapeCsv=(v)=>{if(v==null)return'';const s=String(v);return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s}

/* ============== 요소 레퍼런스 ============== */
const statusText=qs('#statusText');
const btnConnect=qs('#btnConnect');
const roomIdInput=qs('#roomIdInput');
const btnTeacherMode=qs('#btnTeacherMode');
const btnStudentMode=qs('#btnStudentMode');

const joinCard=qs('#joinCard');
const studentQuiz=qs('#studentQuiz');
const questionText=qs('#questionText');
const progressText=qs('#progressText');
const optionsContainer=qs('#optionsContainer');
const subjectiveBox=qs('#subjectiveBox');
const subjectiveInput=qs('#subjectiveInput');
const btnSubmitSubjective=qs('#btnSubmitSubjective');
const quizTypeBadge=qs('#quizTypeBadge');
const answerState=qs('#answerState');
const countdown=qs('#countdown');

const teacherPanel=qs('#teacherPanel');
const tabs=qsa('.tab');
const tabBuild=qs('#tab-build');
const tabControl=qs('#tab-control');
const tabResults=qs('#tab-results');
const quizTitle=qs('#quizTitle');
const questionCount=qs('#questionCount');
const btnBuildForm=qs('#btnBuildForm');
const btnLoadSample=qs('#btnLoadSample');
const builder=qs('#builder');
const btnSaveQuiz=qs('#btnSaveQuiz');

const btnStart=qs('#btnStart');
const btnStop=qs('#btnStop');
const btnPrev=qs('#btnPrev');
const btnNext=qs('#btnNext');
const toggleAccept=qs('#toggleAccept');
const toggleReveal=qs('#toggleReveal');
const ctlQuestion=qs('#ctlQuestion');
const chips=qs('#chips');
const shortGrader=qs('#shortGrader');
const shortAnswers=qs('#shortAnswers');

const timerSec=qs('#timerSec');
const btnTimerStart=qs('#btnTimerStart');
const btnTimerStop=qs('#btnTimerStop');
const teacherCountdown=qs('#teacherCountdown');

const btnExportCSV=qs('#btnExportCSV');
const resultsContainer=qs('#resultsContainer');

const qrCanvas=qs('#qrCanvas');
const studentLinkInput=qs('#studentLink');
const btnCopyLink=qs('#btnCopyLink');
const btnOpenStudent=qs('#btnOpenStudent');

const leaderboard=qs('#leaderboard');
const btnRefreshLeaderboard=qs('#btnRefreshLeaderboard');

/* ============== 상태 ============== */
let MODE = (new URLSearchParams(location.search).get('mode')||'student');
let roomId=''; let me={id:null,name:''};
let unsubRoom=null, unsubResponses=null;
let timerTick=null, teacherTick=null;

/* ============== 탭/모드 ============== */
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  [tabBuild,tabControl,tabResults].forEach(p=>p.classList.add('hidden'));
  const k=t.dataset.tab;
  if(k==='build')tabBuild.classList.remove('hidden');
  if(k==='control')tabControl.classList.remove('hidden');
  if(k==='results')tabResults.classList.remove('hidden');
}));
btnTeacherMode.addEventListener('click',()=>setMode('teacher'));
btnStudentMode.addEventListener('click',()=>setMode('student'));
function setMode(m){
  MODE=m;
  teacherPanel.classList.toggle('hidden',m!=='teacher');
  joinCard.classList.toggle('hidden',m!=='student');
  studentQuiz.classList.toggle('hidden',m!=='student');
  statusText.textContent=m==='teacher'?'관리자 모드: 세션을 연결해 주세요.':'학생 모드: 세션 접속 후 참가하세요.';
}
setMode(MODE==='teacher'?'teacher':'student');

/* ============== 접속/QR/링크 ============== */
btnConnect.addEventListener('click',connectRoom);
async function connectRoom(){
  hideBanner();
  if(!roomIdInput.value.trim()){alert('세션 코드를 입력하세요');return;}
  roomId = roomIdInput.value.trim().replace(/[^a-zA-Z0-9_-]/g,'').slice(0,40);
  roomIdInput.value=roomId;
  try{
    await ensureRoomExists(roomId);
    listenRoom(roomId);
    listenResponses(roomId);
    refreshStudentLink();
  }catch(e){
    console.error(e); showBanner('Firestore 연결 오류: '+(e?.message||e));
  }
}
async function ensureRoomExists(id){
  const ref=db.collection('rooms').doc(id); const snap=await ref.get();
  if(!snap.exists){
    await ref.set({title:'새 세션',mode:'idle',currentIndex:-1,accept:false,reveal:false,timerEndMs:null,questions:[]});
  }
}
function refreshStudentLink(){
  const url=`${location.origin}${location.pathname}?room=${roomId}&mode=student`;
  studentLinkInput.value=url;
  QRCode.toCanvas(qrCanvas,url,{width:160},err=>{if(err)console.error(err)});
}
btnCopyLink.addEventListener('click',()=>{navigator.clipboard.writeText(studentLinkInput.value)});
btnOpenStudent.addEventListener('click',()=>{window.open(studentLinkInput.value,'_blank')});

/* ============== 실시간 리스너 ============== */
function listenRoom(id){
  if(unsubRoom)unsubRoom();
  unsubRoom = db.collection('rooms').doc(id).onSnapshot(snap=>{
    if(!snap.exists)return;
    const r=snap.data();
    renderRoom(r);
  },err=>{console.error(err);showBanner('실시간 수신 오류: '+(err?.message||err))});
}
function listenResponses(id){
  if(unsubResponses)unsubResponses();
  unsubResponses = db.collection('rooms').doc(id).collection('responses').onSnapshot(snap=>{
    const arr=[];snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    renderResponses(arr);
    if(!tabResults.classList.contains('hidden')) buildLeaderboard(arr);
  },err=>{console.error(err);showBanner('응답 수신 오류: '+(err?.message||err))});
}
async function updateRoom(patch){
  if(!roomId)return;
  await db.collection('rooms').doc(roomId).set(patch,{merge:true});
}

/* ============== 학생 참가/제출 ============== */
qs('#btnJoin').addEventListener('click', async ()=>{
  if(MODE!=='student'){alert('학생 모드에서 참가하세요');return;}
  const name=(qs('#studentName').value||'').trim(); if(!name){alert('이름을 입력');return;}
  if(!roomId){alert('먼저 접속');return;}
  const saved = localStorage.getItem(`quiz_uid_${roomId}`) || Math.random().toString(36).slice(2,10);
  localStorage.setItem(`quiz_uid_${roomId}`,saved);
  me={id:saved,name};
  await db.collection('rooms').doc(roomId).collection('responses').doc(me.id).set({
    name, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), answers:{}
  },{merge:true});
  statusText.textContent=`${name} 님, 참가 완료!`;
});
btnSubmitSubjective.addEventListener('click',()=>{const v=(subjectiveInput.value||'').trim(); if(!v){alert('답 입력');return;} submitAnswer(v);});
optionsContainer.addEventListener('click',e=>{
  const b=e.target.closest('[data-opt]'); if(!b)return;
  const idx=parseInt(b.dataset.opt,10); submitAnswer(idx);
});
async function submitAnswer(value){
  if(!me.id){alert('먼저 참가하세요');return;}
  const roomSnap=await db.collection('rooms').doc(roomId).get(); const r=roomSnap.data();
  if(!r.accept){alert('현재 제출이 허용되지 않습니다.');return;}
  const idx=r.currentIndex; const q=r.questions?.[idx]; if(!q)return;
  let correct=null;
  if(q.type==='mcq' && typeof value==='number') correct=(value===(q.answerIndex??-999));
  if(q.type==='short' && typeof value==='string' && q.answerText){
    const norm=s=>String(s).trim().toLowerCase(); correct=(norm(value)===norm(q.answerText));
  }
  await db.collection('rooms').doc(roomId).collection('responses').doc(me.id).set({
    name:me.name,[`answers.${idx}`]:{value,correct:!!correct, revealed: !!r.reveal}
  },{merge:true});
}

/* ============== 렌더링 (학생/관리자 공용) ============== */
function renderRoom(r){
  window.__room=r;
  statusText.textContent=`세션: ${roomId} · 상태: ${r.mode}`;
  // 타이머 표시 (공유 timerEndMs)
  startCountdownDisplays(r.timerEndMs);

  if(MODE==='teacher'){
    toggleAccept.checked=!!r.accept; toggleReveal.checked=!!r.reveal;
    const q=r.questions?.[r.currentIndex];
    ctlQuestion.textContent=q?`${r.currentIndex+1}. ${q.text}`:'-';
    shortGrader.classList.toggle('hidden', !(q && q.type==='short'));
    if(q && q.type==='short') refreshShortAnswers();
  }

  if(MODE==='student'){
    const idx=r.currentIndex; const q=r.questions?.[idx];
    if(r.mode!=='active' || !q){
      questionText.textContent='대기 중입니다…';
      optionsContainer.innerHTML=''; subjectiveBox.classList.add('hidden');
      progressText.textContent='0 / 0'; quizTypeBadge.textContent='대기';
      return;
    }
    progressText.textContent=`${idx+1} / ${r.questions.length}`;
    questionText.textContent=q.text;
    quizTypeBadge.textContent=q.type==='mcq'?'객관식':'주관식';
    answerState.textContent='';
    if(q.type==='mcq'){
      subjectiveBox.classList.add('hidden'); optionsContainer.innerHTML='';
      (q.options||[]).forEach((opt,i)=>{
        const btn=document.createElement('button');
        btn.className='option'; btn.dataset.opt=String(i); btn.textContent=opt; btn.disabled=!r.accept;
        optionsContainer.appendChild(btn);
      });
    }else{
      optionsContainer.innerHTML=''; subjectiveBox.classList.remove('hidden');
      subjectiveInput.value=''; btnSubmitSubjective.disabled=!r.accept;
    }
  }
}
function renderResponses(arr){
  if(MODE==='teacher'){
    chips.innerHTML='';
    arr.forEach(s=>{
      const ans=s.answers?.[window.__room?.currentIndex];
      const chip=document.createElement('div');
      chip.className='chip'+(ans ? (ans.correct?' ok':' no'):'');
      chip.textContent = s.name||s.id; chips.appendChild(chip);
    });
    buildResults(arr);
  }
  if(MODE==='student' && me.id){
    const mine = arr.find(x=>x.id===me.id);
    if(!mine)return;
    const idx=window.__room?.currentIndex;
    const ans=mine.answers?.[idx];
    qsa('.option').forEach((el,i)=>{
      el.classList.remove('selected','correct','wrong');
      if(ans && typeof ans.value==='number' && i===ans.value){
        el.classList.add('selected');
        if(ans.revealed){ el.classList.add(ans.correct?'correct':'wrong'); }
      }
    });
    if(ans && typeof ans.value==='string'){
      answerState.textContent = ans.revealed ? (ans.correct?'정답!':'오답') : `제출: ${ans.value}`;
    }
  }
}

/* ============== 진행 컨트롤 ============== */
btnStart.addEventListener('click',()=>updateRoom({mode:'active',currentIndex:0,accept:true,reveal:false}));
btnStop.addEventListener('click',()=>updateRoom({mode:'ended',accept:false,reveal:true,timerEndMs:null}));
btnPrev.addEventListener('click',()=>stepIndex(-1));
btnNext.addEventListener('click',()=>stepIndex(1));
toggleAccept.addEventListener('change',()=>updateRoom({accept:!!toggleAccept.checked}));
toggleReveal.addEventListener('change',()=>updateRoom({reveal:!!toggleReveal.checked}));

async function stepIndex(delta){
  const ref=db.collection('rooms').doc(roomId);
  await db.runTransaction(async tx=>{
    const snap=await tx.get(ref); const r=snap.data();
    const next=clamp((r.currentIndex??-1)+delta,0,Math.max(0,(r.questions?.length||1)-1));
    tx.set(ref,{currentIndex:next,accept:true,reveal:false,timerEndMs:null},{merge:true});
  });
}

/* ============== 타이머(공유) ============== */
btnTimerStart.addEventListener('click',async ()=>{
  const sec=clamp(parseInt(timerSec.value||'0',10),5,3600);
  const end=Date.now()+sec*1000;
  await updateRoom({timerEndMs:end,accept:true});
});
btnTimerStop.addEventListener('click',()=>updateRoom({timerEndMs:null}));
function startCountdownDisplays(endMs){
  // 학생 카운트다운
  if(timerTick) cancelAnimationFrame(timerTick);
  const tick=()=>{
    const remain=Math.max(0,(endMs??0)-Date.now());
    countdown.textContent=formatMS(remain);
    if(remain>0) timerTick=requestAnimationFrame(tick);
  }; tick();

  // 교사 카운트다운
  if(teacherTick) cancelAnimationFrame(teacherTick);
  const tt=()=>{
    const remain=Math.max(0,(endMs??0)-Date.now());
    teacherCountdown.textContent=formatMS(remain);
    if(remain<=0 && endMs){ // 자동 마감(제출 끔, 결과 공개)
      updateRoom({accept:false,reveal:true,timerEndMs:null});
    }else{ teacherTick=requestAnimationFrame(tt); }
  }; tt();
}
const formatMS=(ms)=>{const s=Math.floor(ms/1000);const m=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');return `${m}:${ss}`}

/* ============== 문항 빌더/저장 ============== */
btnBuildForm.addEventListener('click',()=>{ const n=clamp(parseInt(questionCount.value||'3',10),1,20); builder.innerHTML=''; for(let i=0;i<n;i++) builder.appendChild(buildQuestionRow(i+1)); });
btnLoadSample.addEventListener('click',()=>{
  quizTitle.value='샘플 퀴즈'; questionCount.value=3; builder.innerHTML='';
  const samples=[
    {type:'mcq', text:'태양계에서 가장 큰 행성은?', options:['지구','목성','화성','금성'], answerIndex:1},
    {type:'short', text:'물의 끓는점(°C)은?', answerText:'100'},
    {type:'mcq', text:'우리 몸에 좋은 비타민 C가 많은 과일?', options:['바나나','딸기','사과','수박'], answerIndex:1},
  ];
  samples.forEach((q,i)=>builder.appendChild(buildQuestionRow(i+1,q)));
});
btnSaveQuiz.addEventListener('click',async ()=>{
  if(!roomId){alert('세션 먼저 연결');return;}
  const payload=collectQuizFromBuilder();
  if(payload.questions.length===0){alert('문항을 추가하세요');return;}
  await updateRoom({title:payload.title, questions:payload.questions, mode:'idle', currentIndex:-1, accept:false, reveal:false, timerEndMs:null});
  alert('퀴즈 저장 완료! 진행 탭에서 시작하세요.');
});
function buildQuestionRow(no,q){
  const wrap=document.createElement('div'); wrap.className='panel';
  wrap.innerHTML=`
    <div class="row" style="gap:16px;flex-wrap:wrap">
      <strong>${no}번</strong>
      <label class="row"><input type="radio" name="type-${no}" value="mcq" ${q?.type==='short'?'':'checked'}/>객관식</label>
      <label class="row"><input type="radio" name="type-${no}" value="short" ${q?.type==='short'?'checked':''}/>주관식</label>
    </div>
    <div class="row" style="margin-top:8px"><input class="q-text" data-no="${no}" placeholder="문항 내용" value="${escapeHtml(q?.text||'')}"></div>
    <div class="mcq ${q?.type==='short'?'hidden':''}" style="margin-top:6px">
      <div class="row" style="flex-wrap:wrap;gap:8px">
        ${(q?.options||['','','','']).map((v,i)=>`<input class="opt" data-no="${no}" data-idx="${i}" placeholder="보기 ${i+1}" value="${escapeHtml(v)}" style="width:240px">`).join('')}
      </div>
      <div class="row" style="margin-top:6px">
        <label>정답 번호</label>
        <input class="ansIndex" data-no="${no}" type="number" min="1" max="10" value="${(q?.answerIndex??0)+1}" style="width:100px">
      </div>
    </div>
    <div class="short ${q?.type==='short'?'':'hidden'}" style="margin-top:6px">
      <input class="ansText" data-no="${no}" placeholder="정답(선택, 자동채점용)" value="${escapeHtml(q?.answerText||'')}" style="width:300px">
    </div>`;
  const radios=qsa(`input[name="type-${no}"]`,wrap); const mcq=qs('.mcq',wrap); const short=qs('.short',wrap);
  radios.forEach(r=>r.addEventListener('change',()=>{const isShort=radios.find(x=>x.checked).value==='short'; mcq.classList.toggle('hidden',isShort); short.classList.toggle('hidden',!isShort);}));
  return wrap;
}
function collectQuizFromBuilder(){
  const title=quizTitle.value||'퀴즈';
  const cards=qsa('#builder > .panel');
  const questions=cards.map((card,idx)=>{
    const no=idx+1;
    const type=card.querySelector(`input[name="type-${no}"]:checked`).value;
    const text=card.querySelector('.q-text').value.trim();
    if(!text) return null;
    if(type==='mcq'){
      const opts=qsa('.opt',card).map(x=>x.value.trim()).filter(Boolean);
      const ansIndex=clamp(parseInt(card.querySelector('.ansIndex').value,10)-1,0,Math.max(0,opts.length-1));
      return {type:'mcq', text, options:opts, answerIndex:ansIndex};
    }else{
      const answerText=card.querySelector('.ansText').value.trim();
      return {type:'short', text, answerText};
    }
  }).filter(Boolean);
  return {title, questions};
}

/* ============== 주관식 채점/결과/리더보드/CSV ============== */
async function refreshShortAnswers(){
  if(!roomId)return;
  const room=window.__room; if(!(room && room.questions?.[room.currentIndex]?.type==='short')) return;
  const snap=await db.collection('rooms').doc(roomId).collection('responses').get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  shortAnswers.innerHTML='';
  arr.forEach(s=>{
    const a=s.answers?.[room.currentIndex]; if(!a || typeof a.value!=='string') return;
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
    const left=document.createElement('div'); left.textContent=`${s.name}: ${a.value}`;
    const right=document.createElement('div');
    const ok=document.createElement('button'); ok.className='btn small ghost'; ok.textContent='정답';
    const no=document.createElement('button'); no.className='btn small ghost'; no.textContent='오답';
    ok.addEventListener('click',()=>gradeAnswer(s.id, room.currentIndex, true));
    no.addEventListener('click',()=>gradeAnswer(s.id, room.currentIndex, false));
    right.appendChild(ok); right.appendChild(no);
    row.appendChild(left); row.appendChild(right);
    shortAnswers.appendChild(row);
  });
}
async function gradeAnswer(userId,qIndex,correct){
  await db.collection('rooms').doc(roomId).collection('responses').doc(userId)
    .set({ [`answers.${qIndex}.correct`]:!!correct, [`answers.${qIndex}.revealed`]:true },{merge:true});
}
function buildResults(arr){
  const room=window.__room; if(!room) return;
  const qList=room.questions||[];
  const table=document.createElement('table');
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  ['이름',...qList.map((_,i)=>`Q${i+1}`),'점수'].forEach(h=>{const th=document.createElement('th'); th.textContent=h; trh.appendChild(th)});
  thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  arr.forEach(s=>{
    let score=0; const tr=document.createElement('tr');
    const nameTd=document.createElement('td'); nameTd.textContent=s.name||s.id; tr.appendChild(nameTd);
    qList.forEach((q,i)=>{
      const a=s.answers?.[i]; const td=document.createElement('td');
      if(a){ if(a.correct)score++; td.textContent=q.type==='mcq'?(typeof a.value==='number'?String(a.value+1):'-'):(a.value||'-'); }
      else td.textContent='-';
      tr.appendChild(td);
    });
    const sc=document.createElement('td'); sc.textContent=String(score); tr.appendChild(sc);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  resultsContainer.innerHTML=''; resultsContainer.appendChild(table);
}
function buildLeaderboard(arr){
  const room=window.__room; if(!room) return;
  const qList=room.questions||[];
  const list=arr.map(s=>{
    let score=0; qList.forEach((_,i)=>{ if(s.answers?.[i]?.correct) score++; });
    return {name:s.name||s.id, score};
  }).sort((a,b)=>b.score-a.score).slice(0,10);
  leaderboard.innerHTML='';
  list.forEach((x,i)=>{
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
    const left=document.createElement('div'); left.textContent=`${i+1}. ${x.name}`;
    const right=document.createElement('div'); right.textContent=`${x.score}점`;
    row.appendChild(left); row.appendChild(right);
    leaderboard.appendChild(row);
  });
}
btnRefreshLeaderboard.addEventListener('click',async ()=>{
  const snap=await db.collection('rooms').doc(roomId).collection('responses').get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  buildLeaderboard(arr);
});
btnExportCSV.addEventListener('click',async ()=>{
  if(!roomId) return;
  const roomSnap=await db.collection('rooms').doc(roomId).get(); const room=roomSnap.data();
  const resSnap=await db.collection('rooms').doc(roomId).collection('responses').get();
  const rows=[]; const header=['userId','name',...(room.questions||[]).map((_,i)=>`Q${i+1}`),'score']; rows.push(header.join(','));
  resSnap.forEach(doc=>{
    const d=doc.data(); let score=0;
    const answers=(room.questions||[]).map((q,i)=>{const a=d.answers?.[i]; if(a?.correct)score++; return escapeCsv(a?.value??'');});
    rows.push([doc.id, escapeCsv(d.name), ...answers, score].join(','));
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=`${room.title||roomId}-results.csv`; a.click(); URL.revokeObjectURL(a.href);
});

/* ============== 네트워크 표시 ============== */
window.addEventListener('online',hideBanner);
window.addEventListener('offline',()=>showBanner('⚠️ 오프라인입니다. 인터넷 연결을 확인하세요.'));
</script>
</body>
</html>
