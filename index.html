<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>실시간 퀴즈</title>
    <style>
      :root {
        --bg:#0f1720; --panel:#111a22; --line:#1e2937; --txt:#dbe7ff; --muted:#8aa0bd;
        --pri:#5b6cff; --ok:#1cc88a; --bad:#ff6b6b; --chip:#1b2635;
      }
      *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
      .container{max-width:1200px;margin:0 auto;padding:18px}
      h1{margin:0 0 6px 0;font-size:28px}
      .muted{color:var(--muted)}
      .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
      .row{display:flex;align-items:center;gap:10px}
      .toolbar input, .panel input, .panel select, .panel textarea{background:#0b1220;border:1px solid var(--line);color:var(--txt);padding:8px 10px;border-radius:10px;outline:none}
      .btn{background:var(--pri);color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer}
      .btn.ghost{background:#0b1220;border:1px solid var(--line)}
      .btn.danger{background:var(--bad)}
      .btn:disabled{opacity:.5;cursor:not-allowed}
      .tabs{display:flex;gap:8px;margin-bottom:10px}
      .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--txt);cursor:pointer}
      .tab.active{background:var(--pri)}
      .hidden{display:none}
      .grid{display:grid;gap:14px}
      .grid-2{grid-template-columns:1fr 360px}
      .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--line);color:var(--muted)}
      #chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
      .chip{background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
      .chip.out{color:#bbb;border-color:#3a4457;text-decoration:line-through}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      th,td{border-bottom:1px solid var(--line);padding:10px;text-align:center}
      th{text-align:center;color:#9fb3d9}
      #qrBox{display:grid;place-items:center;height:230px;background:#0b1220;border:1px dashed var(--line);border-radius:12px;margin-bottom:8px}
      #questionArea .option{display:block;width:100%;text-align:left;margin:6px 0;padding:10px 12px;border-radius:10px;background:#0b1220;border:1px solid var(--line);cursor:pointer}
      #questionArea .option.selected{border-color:var(--pri)}
      #questionArea .option.correct{background:#0e2a20;border-color:#1da36d}
      #questionArea .option.wrong{background:#2a0f14;border-color:#b24a4a}
      .note{font-size:12px;color:#8aa0bd}
      .right-col .panel .title{display:flex;justify-content:space-between;align-items:center}
      .kbd{background:#0b1220;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
      @media (max-width:960px){.grid-2{grid-template-columns:1fr}}
    </style>

    <!-- Firebase compat SDKs -->
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- QRCode (전역: window.QRCode) -->
    <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>실시간 퀴즈</h1>

      <!-- 연결/모드 -->
      <div class="panel">
        <div class="row toolbar">
          <span class="badge">세션 코드</span>
          <input id="roomIdInput" placeholder="예: classA" style="max-width:220px" />
          <button id="btnConnect" class="btn">접속</button>
          <span id="statusText" class="muted">관리자 모드: 세션을 연결해 주세요.</span>
          <div style="flex:1"></div>
          <button id="btnTeacherMode" class="btn ghost">관리자</button>
          <button id="btnStudentMode" class="btn ghost">학생</button>
        </div>
      </div>

      <div class="grid grid-2">
        <!-- ===== 왼쪽: 본패널 ===== -->
        <main>
          <div class="tabs">
            <button class="tab active" data-tab="build">문항 만들기</button>
            <button class="tab" data-tab="control">진행</button>
            <button class="tab" data-tab="results">결과</button>
          </div>

          <!-- 관리자 패널 -->
          <section id="teacherPanel" class="panel">
            <!-- 문항 만들기 -->
            <div id="tab-build">
              <div class="row" style="justify-content:space-between">
                <div class="row">
                  <span class="badge">제목</span>
                  <input id="quizTitle" placeholder="퀴즈 제목" style="width:220px" />
                  <span class="badge">문항수</span>
                  <input id="questionCount" type="number" min="1" max="20" value="3" style="width:80px" />
                  <button id="btnBuildForm" class="btn ghost">빈 폼 만들기</button>
                  <button id="btnLoadSample" class="btn ghost">샘플 불러오기</button>
                </div>
                <div class="row">
                  <button id="btnSaveQuiz" class="btn">저장</button>
                  <button id="btnExportRoomJSON" class="btn ghost">JSON 저장</button>
                  <label class="btn ghost" style="cursor:pointer">
                    JSON 불러오기
                    <input id="loadRoomJSON" type="file" accept="application/json" style="display:none">
                  </label>
                </div>
              </div>
              <div id="builder" class="panel" style="margin-top:10px"></div>
            </div>

            <!-- 진행 -->
            <div id="tab-control" class="hidden">
              <div class="row" style="flex-wrap:wrap;gap:12px">
                <label class="row" style="gap:6px"><input type="checkbox" id="toggleAccept" /> 제출 허용</label>
                <label class="row" style="gap:6px"><input type="checkbox" id="toggleGoldenbell" /> 골든벨 모드</label>
                <label class="row" style="gap:6px">
                  정책
                  <select id="submitPolicy">
                    <option value="device">기기당 1회</option>
                    <option value="name">실명당 1회</option>
                  </select>
                </label>
                <label class="row" style="gap:6px">
                  타이머(초)
                  <input id="timerSec" type="number" min="0" value="30" style="width:80px" />
                  <button id="btnTimerStart" class="btn ghost">타이머 시작</button>
                  <button id="btnTimerStop" class="btn ghost">타이머 정지</button>
                  <span class="badge">남은 시간 <span id="leftTime">00:00</span></span>
                </label>
                <div class="row">
                  <button id="btnStart" class="btn">시작</button>
                  <button id="btnPrev" class="btn ghost">이전</button>
                  <button id="btnNext" class="btn ghost">다음</button>
                  <button id="btnStop" class="btn danger">종료</button>
                </div>
                <div class="row">
                  <button id="btnOpenPresent" class="btn ghost">프레젠테이션 화면 열기</button>
                </div>
              </div>

              <div class="panel" style="margin-top:12px">
                <div class="row"><span class="badge">현재:</span><span id="ctlQuestion">-</span></div>
                <div id="chips" class="chips"></div>
              </div>

              <!-- 주관식 채점 -->
              <div class="panel hidden" id="shortGrader">
                <div class="row"><span class="badge">주관식 채점</span></div>
                <div id="shortAnswers"></div>
              </div>
            </div>

            <!-- 결과 -->
            <div id="tab-results" class="hidden">
              <div class="row" style="gap:8px">
                <button id="btnExportCSV" class="btn ghost">CSV 내보내기</button>
                <button id="btnResetAll" class="btn danger">전체 초기화</button>
              </div>
              <div id="resultsContainer"></div>
            </div>
          </section>

          <!-- 학생 패널 -->
          <section id="studentPanel" class="panel hidden">
            <div class="row" style="gap:10px;flex-wrap:wrap">
              <span class="badge">이름</span>
              <input id="studentName" placeholder="예: 홍길동" style="width:200px" />
              <button id="btnJoin" class="btn">참가</button>
              <span class="muted" id="joinedHint"></span>
            </div>
            <div class="panel" id="questionArea" style="margin-top:12px">
              <div class="row" style="justify-content:space-between;align-items:center">
                <div class="row">
                  <span class="badge">진행</span><span id="progressText">0 / 0</span>
                </div>
                <span class="badge" id="quizTypeBadge">대기</span>
              </div>
              <h3 id="questionText" style="margin:10px 0 6px">대기 중입니다…</h3>
              <div id="optionsContainer"></div>
              <div id="subjectiveBox" class="hidden">
                <div class="row" style="gap:8px">
                  <input id="subjectiveInput" placeholder="답을 입력하세요" style="flex:1" />
                  <button id="btnSubmitSubjective" class="btn">제출</button>
                </div>
              </div>
              <div class="note" id="answerState"></div>
              <div class="note">※ 객관식도 <span class="kbd">제출</span> 버튼이 표시됩니다.</div>
            </div>
          </section>
        </main>

        <!-- ===== 오른쪽: 접속/QR/가이드 ===== -->
        <aside class="right-col">
          <section class="panel">
            <div class="title">
              <span class="badge">학생용 접속 QR</span>
              <button id="btnCopy" class="btn ghost">링크 복사</button>
            </div>
            <div id="qrBox"></div>
            <input id="studentLinkInput" readonly />
            <div class="note">링크/QR은 세션에 맞춰 자동 갱신됩니다.</div>
            <div class="note" style="margin-top:6px">정책: <b>기기당 1회</b>가 기본이며, “실명당 1회”로 바꾸면 같은 이름으로 1번만 제출됩니다.</div>
          </section>

          <section class="panel">
            <div class="title"><span class="badge">사용 가이드</span></div>
            <ul class="note" style="margin:6px 0 0 16px;line-height:1.5">
              <li><b>문항 만들기</b>: 빈 폼 또는 샘플 불러오기 → 저장</li>
              <li><b>진행</b>: 시작 → 제출 허용/타이머 → 다음/이전</li>
              <li><b>골든벨</b>: 오답 즉시 탈락, 결과/칩에 표시</li>
              <li><b>프레젠테이션</b>: 큰 화면으로 문제 공유</li>
              <li><b>결과</b>: CSV, 전체 초기화, JSON 저장/불러오기</li>
            </ul>
          </section>
        </aside>
      </div>
    </div>

    <!-- 메인 로직 -->
    <script type="module" src="./app.js"></script>
  </body>
</html>
