<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>실시간 퀴즈 (교무)</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root {
      --bg:#0c1117;--panel:#121826;--muted:#8aa0b4;--text:#e8eef5;
      --primary:#5b6cff;--primary-500:#5661ff;--primary-700:#3b45d6;
      --accent:#3ecf8e;--danger:#ff5d5d;--warn:#ffb020;--blue:#67b0ff;
      --chip:#1a2336;--chip-ok:#193a2a;--chip-no:#3a1a1a;
      --input-bg:#0f1a2b;--input-br:#2a3954;--input-txt:#eaf2ff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,AppleSDGothicNeo,"Malgun Gothic",Pretendard,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--blue);text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .dot{width:8px;height:8px;border-radius:50%;background:#ff4747;box-shadow:0 0 10px #ff4747}
    h1{font-size:28px;margin:0 6px 0 0}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid #2a3550;background:#161e31;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;transition:.15s;user-select:none;font-weight:600}
    .btn:hover{filter:brightness(1.08)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .sm{padding:6px 10px;font-weight:600}
    .p{background:var(--primary);border-color:var(--primary-700);color:#fff}
    .g{background:var(--accent);border-color:#2aa871;color:#01210f}
    .w{background:var(--warn);border-color:#c57f00;color:#201300}
    .d{background:var(--danger);border-color:#b42e2e;color:#1f0707}
    .o{background:#1b2438}
    .ghost{background:transparent;border-color:#415278;color:#cfe2ff}
    .tabs .tab{padding:7px 14px;border-radius:10px;background:#0f1626;border:1px solid #28324a;color:#b9c6d9;cursor:pointer}
    .tabs .tab.active{background:#1a2440;color:#eef6ff;border-color:#3b4c70}
    .row{display:flex;align-items:center;gap:10px}
    .grid{display:grid;gap:14px}
    .two{grid-template-columns:1.35fr .65fr}
    .card{background:var(--panel);border:1px solid #24314a;border-radius:16px;padding:16px}
    .subtle{color:#9ab0c5}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#172036;border:1px solid #2e3b57;color:#9fc1ff;font-weight:700;font-size:12px}
    .switch{display:flex;align-items:center;gap:6px;margin-right:10px}
    .switch input{transform:scale(1.1)}
    label{color:#cfe2ff}
    input,textarea,select{border:1px solid var(--input-br);background:var(--input-bg);color:var(--input-txt);border-radius:10px;padding:9px 11px;outline:none}
    input::placeholder,textarea::placeholder{color:#93a7bf}
    input:focus,textarea:focus,select:focus{border-color:#5b6cff;box-shadow:0 0 0 3px rgba(91,108,255,.15)}
    textarea{min-height:70px;resize:vertical}
    .hr{height:1px;background:#24314a;margin:14px 0}
    .hidden{display:none !important}
    .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid #2e3d63;color:#d9e7ff;font-weight:700}
    .chip.ok{background:var(--chip-ok);border-color:#2c7b57;color:#b9ffd9}
    .chip.no{background:var(--chip-no);border-color:#7b2c2c;color:#ffc3c3}
    .list{display:flex;gap:8px;flex-wrap:wrap}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #21304b;padding:8px 10px;text-align:left}
    .table th{color:#a5c4ff}
    .option{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:12px;border:1px solid #2a3a5d;background:#0f1a2b;color:#eaf2ff;cursor:pointer}
    .option:hover{filter:brightness(1.07)}
    .option.selected{outline:2px solid var(--blue)}
    .option.correct{background:#143023;border-color:#2a7a54}
    .option.wrong{background:#311717;border-color:#7a2a2a}
    .help h3{margin:10px 0 6px;font-size:13px;color:#cfe2ff}
    .help ul{margin:0 0 10px 18px;padding:0}
    .help li{margin:4px 0;color:#9db3c9}
    .pill{padding:3px 8px;border-radius:999px;background:#12233b;border:1px solid #2c456e;color:#a7c4ff}
    .qrbox{display:flex;gap:12px;align-items:flex-start}
    .qr{width:210px;height:210px;background:#fff;border-radius:12px;display:grid;place-items:center}
    .rightNote{font-size:12px;color:#9eb3c8}
    .mini{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="dot"></span><h1>실시간 퀴즈</h1>
      <span class="pill" id="liveState">대기</span>
    </header>

    <!-- 접속 바 -->
    <div class="bar">
      <span class="badge">세션 코드</span>
      <input id="roomIdInput" placeholder="예: classA" style="width:200px">
      <button class="btn p sm" id="btnConnect">접속</button>
      <button class="btn o sm" id="btnTeacherMode">관리자</button>
      <button class="btn o sm" id="btnStudentMode">학생</button>
      <span class="subtle" id="statusText">세션에 접속해 주세요.</span>
    </div>

    <!-- 메인 그리드 -->
    <div class="grid two" style="margin-top:16px">

      <!-- 좌: 본 패널 -->
      <div>

        <!-- 학생 Join / 퀴즈 -->
        <div id="joinCard" class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="badge">학생 참여</div>
              <div class="muted mini">세션 접속 후 이름을 입력하고 참가하세요.</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px;gap:10px">
            <input id="studentName" placeholder="이름" style="width:200px">
            <button class="btn g sm" id="btnJoin">참가</button>
          </div>
        </div>

        <div id="studentQuiz" class="card hidden">
          <div class="row" style="justify-content:space-between">
            <div class="row" style="gap:8px">
              <span class="badge" id="quizTypeBadge">대기</span>
              <span class="pill">진행 <b id="progressText">0 / 0</b></span>
            </div>
            <div class="muted mini" id="answerState"></div>
          </div>

          <h3 id="questionText" style="margin:10px 0 12px">대기 중입니다…</h3>

          <div class="grid" id="optionsContainer" style="gap:8px"></div>

          <div id="subjectiveBox" class="hidden" style="margin-top:10px">
            <div class="row" style="gap:8px">
              <input id="subjectiveInput" placeholder="정답을 입력하세요" style="flex:1">
              <button class="btn p sm" id="btnSubmitSubjective">제출</button>
            </div>
          </div>
        </div>

        <!-- 관리자 탭 -->
        <div id="teacherPanel" class="card hidden">
          <div class="row" style="justify-content:space-between;align-items:flex-end">
            <div>
              <div class="badge">관리자 모드</div>
              <div class="muted mini" id="roomInfo">세션 연결 필요</div>
            </div>
            <div class="tabs row">
              <div class="tab active" data-tab="build">문항 만들기</div>
              <div class="tab" data-tab="control">진행</div>
              <div class="tab" data-tab="results">결과</div>
            </div>
          </div>

          <!-- Build -->
          <section id="tab-build" style="margin-top:14px">
            <div class="row" style="gap:10px;flex-wrap:wrap">
              <input id="quizTitle" placeholder="퀴즈 제목" style="width:260px">
              <span class="row" style="gap:6px"><label class="muted mini">문항 수</label><input id="questionCount" type="number" value="3" min="1" max="20" style="width:90px"></span>
              <button class="btn sm o" id="btnBuildForm">빈 폼 만들기</button>
              <button class="btn sm o" id="btnLoadSample">샘플 불러오기</button>
              <button class="btn sm p" id="btnSaveQuiz">퀴즈 저장</button>
              <button class="btn sm ghost" id="btnLoadJSON">불러오기</button>
              <button class="btn sm ghost" id="btnSaveJSON">JSON 저장</button>
            </div>
            <div id="builder" class="grid" style="margin-top:12px"></div>
          </section>

          <!-- Control -->
          <section id="tab-control" class="hidden" style="margin-top:14px">
            <div class="grid two">
              <div class="card">
                <div class="row" style="gap:8px;flex-wrap:wrap">
                  <button class="btn p" id="btnStart">시작</button>
                  <button class="btn o" id="btnPrev">이전</button>
                  <button class="btn o" id="btnNext">다음</button>
                  <button class="btn d" id="btnStop">마감</button>

                  <label class="switch"><input type="checkbox" id="toggleAccept"><span>제출 허용</span></label>
                  <label class="switch"><input type="checkbox" id="toggleReveal"><span>결과 공개</span></label>
                  <label class="switch"><input type="checkbox" id="toggleBell"><span>골든벨</span></label>
                </div>

                <div class="hr"></div>

                <div class="row" style="gap:14px;flex-wrap:wrap">
                  <span class="badge">타이머(초)</span>
                  <input id="timerSec" type="number" value="30" min="5" max="600" style="width:90px">
                  <button class="btn w sm" id="btnTimerStart">타이머 시작</button>
                  <button class="btn ghost sm" id="btnTimerStop">타이머 정지</button>
                  <span class="pill">남은 시간 <b id="leftTime">00:00</b></span>
                  <span class="muted">현재: <b id="ctlQuestion">-</b></span>
                </div>

                <div class="hr"></div>

                <div>
                  <div class="muted mini">정답/탈락 현황</div>
                  <div id="chips" class="list" style="margin-top:8px"></div>
                </div>

                <div id="shortGrader" class="hidden" style="margin-top:12px">
                  <div class="muted mini">주관식 채점</div>
                  <div id="shortAnswers" class="grid" style="margin-top:6px;gap:6px"></div>
                </div>
              </div>

              <div class="card">
                <div class="muted mini">학생용 접속 QR</div>
                <div class="qrbox" style="margin-top:8px">
                  <div class="qr" id="qrBox"><div id="qr"></div></div>
                  <div style="flex:1">
                    <div class="muted mini">링크</div>
                    <input id="studentLink" readonly style="width:100%;margin:6px 0">
                    <div class="row" style="gap:8px">
                      <button class="btn o sm" id="btnCopy">링크 복사</button>
                      <button class="btn sm ghost" id="btnOpenStudent">학생 모드로 열기</button>
                    </div>
                    <p class="rightNote">QR/링크는 <b>세션 코드</b>와 현재 설정을 반영합니다.</p>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Results -->
          <section id="tab-results" class="hidden" style="margin-top:14px">
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <button class="btn sm o" id="btnExportCSV">CSV 내보내기</button>
              <button class="btn sm d" id="btnResetRoom">전체 초기화</button>
            </div>
            <div id="resultsContainer" style="margin-top:12px" class="card"></div>
          </section>
        </div>
      </div>

      <!-- 우: 도움말 -->
      <aside class="card">
        <div id="help-teacher" class="help">
          <h3>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#9fc1ff" style="vertical-align:-2px;margin-right:6px"><path d="M3 5a2 2 0 0 1 2-2h11a3 3 0 0 1 3 3v11a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2V5Z"/><path d="M19 17V6a2 2 0 0 0-2-2H7"/></svg>
            관리자 모드 사용법
          </h3>
          <ul>
            <li>세션 코드 입력 → <b>접속</b></li>
            <li><b>문항 만들기</b>에서 객관식/주관식 작성 → <b>퀴즈 저장</b></li>
            <li><b>진행</b> 탭에서 <b>시작</b>, <b>제출 허용</b> 토글</li>
            <li><b>골든벨</b>: 공개 시 오답 자동 탈락</li>
            <li>결과는 <b>JSON/CSV</b>로 저장 가능</li>
          </ul>
          <div class="hr"></div>
          <h3>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#ffd36b" style="vertical-align:-2px;margin-right:6px"><path d="M9 18h6v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2Z"/><path d="M8 14a6 6 0 1 1 8 0l-1 1v1H9v-1l-1-1Z"/></svg>
            팁
          </h3>
          <ul>
            <li>타이머는 문제 시작 직후 켜면 집중도 UP</li>
            <li>주관식은 정답 텍스트를 쓰면 자동채점</li>
            <li>QR/링크는 접속 후 자동 생성됩니다</li>
          </ul>
        </div>

        <div id="help-student" class="help hidden">
          <h3>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#91e3c0" style="vertical-align:-2px;margin-right:6px"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z"/><path d="M4 20a8 8 0 0 1 16 0Z"/></svg>
            학생 사용법
          </h3>
          <ul>
            <li>세션 코드 입력 → <b>접속</b> → 이름 → <b>참가</b></li>
            <li>객관식: 보기 클릭 / 주관식: 입력 후 <b>제출</b></li>
            <li>교사가 <b>제출 허용</b>을 켰을 때만 제출돼요</li>
          </ul>
        </div>
      </aside>
    </div>
  </div>

  <!-- QRCodeJS (new QRCode(...)) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Firebase (CDN, v9 modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, runTransaction,
      collection, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ===== Firebase 설정(요청하신 값 반영) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCClNc95ykYCudmLHTPgpewZ60bZ8zukbo",
      authDomain: "live-quiz-a14d1.firebaseapp.com",
      projectId: "live-quiz-a14d1"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== DOM =====
    const qs =(s,el=document)=>el.querySelector(s);
    const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s));

    const liveState=qs('#liveState');
    const btnConnect=qs('#btnConnect');
    const roomIdInput=qs('#roomIdInput');
    const btnTeacherMode=qs('#btnTeacherMode');
    const btnStudentMode=qs('#btnStudentMode');
    const statusText=qs('#statusText');

    const joinCard=qs('#joinCard');
    const studentQuiz=qs('#studentQuiz');
    const studentName=qs('#studentName');
    const btnJoin=qs('#btnJoin');
    const questionText=qs('#questionText');
    const progressText=qs('#progressText');
    const optionsContainer=qs('#optionsContainer');
    const subjectiveBox=qs('#subjectiveBox');
    const subjectiveInput=qs('#subjectiveInput');
    const btnSubmitSubjective=qs('#btnSubmitSubjective');
    const quizTypeBadge=qs('#quizTypeBadge');
    const answerState=qs('#answerState');

    const teacherPanel=qs('#teacherPanel');
    const tabs=qsa('.tab'); const tabBuild=qs('#tab-build'); const tabControl=qs('#tab-control'); const tabResults=qs('#tab-results');

    const roomInfo=qs('#roomInfo');
    const quizTitle=qs('#quizTitle'); const questionCount=qs('#questionCount');
    const btnBuildForm=qs('#btnBuildForm'); const btnLoadSample=qs('#btnLoadSample'); const builder=qs('#builder'); const btnSaveQuiz=qs('#btnSaveQuiz');

    const btnStart=qs('#btnStart'); const btnStop=qs('#btnStop'); const btnPrev=qs('#btnPrev'); const btnNext=qs('#btnNext');
    const toggleAccept=qs('#toggleAccept'); const toggleReveal=qs('#toggleReveal'); const toggleBell=qs('#toggleBell');
    const ctlQuestion=qs('#ctlQuestion'); const chips=qs('#chips'); const shortGrader=qs('#shortGrader'); const shortAnswers=qs('#shortAnswers');

    const timerSec=qs('#timerSec'); const btnTimerStart=qs('#btnTimerStart'); const btnTimerStop=qs('#btnTimerStop'); const leftTime=qs('#leftTime');

    const qrBox=qs('#qr'); const studentLink=qs('#studentLink'); const btnCopy=qs('#btnCopy'); const btnOpenStudent=qs('#btnOpenStudent');

    const btnExportCSV=qs('#btnExportCSV'); const btnResetRoom=qs('#btnResetRoom'); const resultsContainer=qs('#resultsContainer');
    const btnLoadJSON=qs('#btnLoadJSON'); const btnSaveJSON=qs('#btnSaveJSON');

    // ===== 상태 =====
    let MODE='student', roomId='', me={ id:null, name:'' }, unsubRoom=null, unsubResponses=null, roomKey=null;
    let timer=null, timerEnd=0;
    const myDeviceKey = (()=>{ const k=localStorage.getItem('quiz_device_key')||crypto.randomUUID(); localStorage.setItem('quiz_device_key',k); return k; })();

    // 탭
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      [tabBuild,tabControl,tabResults].forEach(p=>p.classList.add('hidden'));
      const name=t.dataset.tab; qs('#tab-'+name).classList.remove('hidden');
    }));

    // 모드 전환
    function setMode(m){
      MODE=m;
      teacherPanel.classList.toggle('hidden', m!=='teacher');
      joinCard.classList.toggle('hidden', m!=='student');
      studentQuiz.classList.toggle('hidden', m!=='student');
      qs('#help-teacher').classList.toggle('hidden', m!=='teacher');
      qs('#help-student').classList.toggle('hidden', m!=='student');
      statusText.textContent = (m==='teacher') ? '관리자 모드: 세션을 연결해 주세요.' : '학생 모드: 세션 접속 후 참가하세요.';
    }
    btnTeacherMode.onclick=()=>setMode('teacher');
    btnStudentMode.onclick=()=>setMode('student');

    // 접속
    btnConnect.onclick=async ()=>{
      roomId=(roomIdInput.value||'').trim();
      if(!roomId){ alert('세션 코드를 입력하세요'); return; }
      await ensureRoomExists(roomId);
      listenRoom(roomId); listenResponses(roomId);
      refreshStudentLink();
    };

    // 학생 참가
    btnJoin.onclick=async ()=>{
      if(MODE!=='student'){ alert('학생 모드에서만 참가합니다.'); return; }
      if(!roomId){ alert('먼저 세션에 접속하세요'); return; }
      const name=(studentName.value||'').trim(); if(!name){ alert('이름을 입력하세요'); return; }
      me={ id: myDeviceKey, name };
      await setDoc(doc(db,'rooms',roomId,'responses',me.id),{
        name, joinedAt: serverTimestamp(), answers:{}, status:'alive'
      },{merge:true});
      alert(`${name} 님, 참가 완료!`);
      statusText.textContent=`${name} 님, 참가 완료`;
    };

    // 빈 폼/샘플/저장
    btnBuildForm.onclick=()=>{
      const n=clamp(parseInt(questionCount.value||'3',10),1,20);
      builder.innerHTML=''; for(let i=0;i<n;i++) builder.appendChild(buildQuestionRow(i+1));
    };
    btnLoadSample.onclick=()=>{
      quizTitle.value='샘플 퀴즈'; questionCount.value=3; builder.innerHTML='';
      const s=[
        {type:'mcq', text:'태양계에서 가장 큰 행성은?', options:['지구','목성','화성','금성'], answerIndex:1},
        {type:'short', text:'물의 끓는점(°C)은?', answerText:'100'},
        {type:'mcq', text:'바다의 소금기는 어디서 올까요?', options:['소금산','강물의 광물질','하늘','바람'], answerIndex:1}
      ];
      s.forEach((q,i)=>builder.appendChild(buildQuestionRow(i+1,q)));
    };
    btnSaveQuiz.onclick=async ()=>{
      if(!roomId){ alert('세션을 먼저 연결하세요.'); return; }
      const payload=collectQuizFromBuilder();
      if(payload.questions.length===0){ alert('문항을 추가하세요.'); return; }
      // roomKey 없으면 생성
      const rRef=doc(db,'rooms',roomId);
      const snap=await getDoc(rRef); roomKey = (snap.exists() && snap.data().roomKey) || crypto.randomUUID();
      await setDoc(rRef,{
        title: payload.title, mode:'idle', currentIndex:-1, accept:false, reveal:false, bell:false,
        createdAt: serverTimestamp(), questions: payload.questions, roomKey
      },{merge:true});
      alert('퀴즈 저장 완료! 진행 탭에서 시작하세요.');
      refreshStudentLink();
    };

    // 진행 제어
    btnStart.onclick = ()=> updateRoom({ mode:'active', currentIndex:0, accept:true });
    btnStop.onclick  = ()=> updateRoom({ mode:'ended',  accept:false });
    btnPrev.onclick  = ()=> stepIndex(-1);
    btnNext.onclick  = ()=> stepIndex(1);
    toggleAccept.onchange = ()=> updateRoom({ accept: !!toggleAccept.checked });
    toggleReveal.onchange = ()=> updateRoom({ reveal: !!toggleReveal.checked });
    toggleBell.onchange   = ()=> updateRoom({ bell: !!toggleBell.checked });

    // 타이머
    btnTimerStart.onclick = ()=>{
      const sec=clamp(parseInt(timerSec.value||'30',10),1,600);
      timerEnd=Date.now()+sec*1000;
      if(timer) clearInterval(timer);
      timer=setInterval(()=>{
        const left=Math.max(0, Math.floor((timerEnd-Date.now())/1000));
        leftTime.textContent = formatMMSS(left);
        if(left<=0){ clearInterval(timer); timer=null; }
      },200);
    };
    btnTimerStop.onclick = ()=>{ if(timer) clearInterval(timer); timer=null; leftTime.textContent='00:00'; };

    // 학생 제출
    optionsContainer.addEventListener('click',e=>{
      const btn=e.target.closest('.option'); if(!btn) return;
      submitAnswer(parseInt(btn.dataset.opt,10));
    });
    btnSubmitSubjective.onclick=()=>{ const v=(subjectiveInput.value||'').trim(); if(!v){alert('답을 입력하세요');return;} submitAnswer(v); };

    // 결과/초기화/CSV/JSON
    btnExportCSV.onclick=exportCSV;
    btnResetRoom.onclick=async ()=>{
      if(!roomId) return; if(!confirm('모든 응답/상태를 초기화할까요?')) return;
      // 응답 삭제 & 방 상태 초기화
      const rs=await getDocs(collection(db,'rooms',roomId,'responses'));
      for(const d of rs.docs){ await setDoc(d.ref,{answers:{},status:'alive'},{merge:true}); }
      await updateRoom({ mode:'idle', currentIndex:-1, accept:false, reveal:false });
      alert('초기화 완료');
    };
    btnSaveJSON.onclick=async ()=>{
      if(!roomId) return;
      const r=await getDoc(doc(db,'rooms',roomId));
      downloadFile(`quiz-${roomId}.json`, JSON.stringify(r.data()||{},null,2),'application/json');
    };
    btnLoadJSON.onclick=()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange=async (e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        const txt=await f.text(); const data=JSON.parse(txt);
        if(!roomId){ alert('세션에 먼저 접속하세요.'); return; }
        await setDoc(doc(db,'rooms',roomId), data, {merge:true});
        alert('불러오기 완료'); refreshStudentLink();
      };
      inp.click();
    };

    // 링크/QR
    btnCopy.onclick=()=>{ navigator.clipboard.writeText(studentLink.value||''); };
    btnOpenStudent.onclick=()=>{ window.open(studentLink.value||'#','_blank'); };

    // ===== Firestore helper =====
    async function ensureRoomExists(id){
      const ref=doc(db,'rooms',id); const s=await getDoc(ref);
      if(!s.exists()){
        roomKey = crypto.randomUUID();
        await setDoc(ref,{ title:'새 세션', mode:'idle', currentIndex:-1, accept:false, reveal:false, bell:false, roomKey, questions:[] });
      } else {
        roomKey = s.data().roomKey || null;
      }
    }
    function listenRoom(id){
      if(unsubRoom) unsubRoom();
      unsubRoom = onSnapshot(doc(db,'rooms',id),(snap)=>{
        if(!snap.exists()) return;
        const r=snap.data();
        window.__lastRoom = r; // cache
        renderRoom(r);
      });
    }
    function listenResponses(id){
      if(unsubResponses) unsubResponses();
      unsubResponses = onSnapshot(collection(db,'rooms',id,'responses'),(snap)=>{
        const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
        renderResponses(arr);
      });
    }
    async function updateRoom(patch){
      if(!roomId) return;
      await setDoc(doc(db,'rooms',roomId), patch, {merge:true});
    }
    async function stepIndex(delta){
      const ref=doc(db,'rooms',roomId);
      await runTransaction(db, async (tx)=>{
        const s=await tx.get(ref); const r=s.data(); const max=(r.questions?.length||0)-1;
        const next = clamp((r.currentIndex??-1)+delta, 0, Math.max(0,max));
        tx.set(ref,{ currentIndex: next, accept:true },{merge:true});
      });
    }

    // ===== Render =====
    function renderRoom(r){
      liveState.textContent = (r.mode==='active'?'진행중':(r.mode==='ended'?'마감':'대기'));
      if(MODE==='teacher'){
        roomInfo.textContent = `세션: ${roomId} · 상태: ${liveState.textContent}`;
        toggleAccept.checked=!!r.accept; toggleReveal.checked=!!r.reveal; toggleBell.checked=!!r.bell;
        const q=r.questions?.[r.currentIndex]; ctlQuestion.textContent=q?`${r.currentIndex+1}. ${q.text}`:'-';
        shortGrader.classList.toggle('hidden', !(q && q.type==='short'));
        if(q && q.type==='short') buildShortAnswerList(r);
      }
      if(MODE==='student'){
        const idx=r.currentIndex; const q=r.questions?.[idx];
        if(r.mode!=='active'||!q){
          studentQuiz.classList.remove('hidden');
          questionText.textContent='대기 중입니다…'; optionsContainer.innerHTML=''; subjectiveBox.classList.add('hidden');
          progressText.textContent='0 / 0'; quizTypeBadge.textContent='대기'; answerState.textContent='';
          return;
        }
        progressText.textContent=`${idx+1} / ${r.questions.length}`;
        questionText.textContent=q.text; quizTypeBadge.textContent=q.type==='mcq'?'객관식':'주관식'; answerState.textContent='';
        if(q.type==='mcq'){
          optionsContainer.innerHTML=''; subjectiveBox.classList.add('hidden');
          (q.options||[]).forEach((opt,i)=>{
            const b=document.createElement('button'); b.className='option'; b.textContent=opt; b.dataset.opt=String(i); b.disabled=!r.accept;
            optionsContainer.appendChild(b);
          });
        }else{
          optionsContainer.innerHTML=''; subjectiveBox.classList.remove('hidden'); subjectiveInput.value=''; btnSubmitSubjective.disabled=!r.accept;
        }
      }
    }

    function renderResponses(arr){
      if(MODE==='teacher'){
        chips.innerHTML=''; const room=window.__lastRoom||{};
        arr.forEach(s=>{
          const a=s.answers?.[room.currentIndex]; const chip=document.createElement('div');
          chip.className='chip '+(a? (a.correct?'ok': (room.reveal?'no':'')) : '');
          chip.textContent=s.name||s.id; chips.appendChild(chip);
        });
        buildShortAnswerListCached(arr);
        buildResults(arr);
      }
      if(MODE==='student'&&me.id){
        const mine=arr.find(x=>x.id===me.id); if(!mine) return;
        const idx=(window.__lastRoom||{}).currentIndex; const ans=mine.answers?.[idx];
        qsa('.option').forEach((el,i)=>{
          el.classList.remove('selected','correct','wrong');
          if(ans && typeof ans.value==='number'){
            if(i===ans.value) el.classList.add('selected');
            if((window.__lastRoom||{}).reveal){
              if(ans.correct && i===ans.value) el.classList.add('correct');
              if(!ans.correct && i===ans.value) el.classList.add('wrong');
            }
          }
        });
        if(ans && typeof ans.value==='string'){
          answerState.textContent = (window.__lastRoom||{}).reveal ? (ans.correct?'정답!':'오답') : `제출: ${ans.value}`;
        }
      }
    }

    function buildShortAnswerList(room){
      window.__lastRoom=room;
      getDocs(collection(db,'rooms',roomId,'responses')).then(s=>{
        const arr=[]; s.forEach(d=>arr.push({id:d.id,...d.data()}));
        buildShortAnswerListCached(arr);
      });
    }
    function buildShortAnswerListCached(arr){
      if(MODE!=='teacher') return; const room=window.__lastRoom||{}; const q=room.questions?.[room.currentIndex]; if(!q||q.type!=='short') return;
      shortAnswers.innerHTML='';
      arr.forEach(s=>{
        const a=s.answers?.[room.currentIndex]; if(!a||typeof a.value!=='string') return;
        const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
        const left=document.createElement('div'); left.textContent=`${s.name}: ${a.value}`;
        const right=document.createElement('div');
        const ok=document.createElement('button'); ok.className='btn ghost sm'; ok.textContent='정답';
        const no=document.createElement('button'); no.className='btn ghost sm'; no.textContent='오답';
        ok.onclick=()=>gradeAnswer(s.id, room.currentIndex,true);
        no.onclick=()=>gradeAnswer(s.id, room.currentIndex,false);
        right.append(ok,no); row.append(left,right); shortAnswers.appendChild(row);
      });
    }

    async function gradeAnswer(uid, qIndex, correct){
      await setDoc(doc(db,'rooms',roomId,'responses',uid),{
        [`answers.${qIndex}.correct`]: !!correct, [`answers.${qIndex}.revealed`]: true
      },{merge:true});
    }

    // 제출 (roomKey 포함, 기기당 1회/문항)
    async function submitAnswer(value){
      if(!me.id){ alert('먼저 참가하세요'); return; }
      const rRef=doc(db,'rooms',roomId); const rSnap=await getDoc(rRef); const r=rSnap.data()||{};
      if(!r.accept){ alert('현재 제출이 허용되지 않습니다.'); return; }
      const idx=r.currentIndex; const q=r.questions?.[idx]; if(!q) return;
      // 기기당 1회(동일 문항 재제출 방지)
      const myRef=doc(db,'rooms',roomId,'responses',me.id); const mySnap=await getDoc(myRef);
      const already = mySnap.exists() && mySnap.data().answers && (mySnap.data().answers[idx]!=null);
      if(already){ alert('이미 제출했습니다.'); return; }

      let correct=null;
      if(q.type==='mcq' && typeof value==='number'){ correct=(value===(q.answerIndex??-999)); }
      else if(q.type==='short' && typeof value==='string'){
        const norm=s=>String(s).trim().toLowerCase(); if(q.answerText) correct=(norm(value)===norm(q.answerText));
      }

      await setDoc(myRef,{
        name: me.name, roomKey: r.roomKey || null,
        [`answers.${idx}`]: { value, correct: (correct===true), revealed: (q.type==='mcq') }
      },{merge:true});
    }

    function buildResults(arr){
      if(MODE!=='teacher') return; const room=window.__lastRoom||{}; const qs=room.questions||[];
      const table=document.createElement('table'); table.className='table';
      const thead=document.createElement('thead'); const htr=document.createElement('tr');
      ['이름', ...qs.map((_,i)=>`Q${i+1}`), '점수','상태'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; htr.appendChild(th); }); thead.appendChild(htr); table.appendChild(thead);
      const tbody=document.createElement('tbody');
      arr.forEach(s=>{
        const tr=document.createElement('tr'); const tdName=document.createElement('td'); tdName.textContent=s.name||s.id; tr.appendChild(tdName);
        let score=0;
        qs.forEach((q,i)=>{ const td=document.createElement('td'); const a=s.answers?.[i];
          if(a){ if(a.correct) score++; td.textContent = q.type==='mcq' ? (typeof a.value==='number'?String(a.value+1):'-') : (a.value||'-'); } else td.textContent='-';
          tr.appendChild(td);
        });
        const tdScore=document.createElement('td'); tdScore.textContent=String(score); tr.appendChild(tdScore);
        const tdStat=document.createElement('td'); tdStat.textContent=s.status||'-'; tr.appendChild(tdStat);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      resultsContainer.innerHTML=''; resultsContainer.appendChild(table);
    }

    // QR/링크 갱신
    function refreshStudentLink(){
      const url=new URL(location.href);
      url.searchParams.set('mode','student'); url.searchParams.set('room',roomId);
      const link=url.toString();
      studentLink.value=link;
      // QRCodeJS
      qrBox.innerHTML=''; new QRCode(qrBox,{text:link,width:200,height:200,correctLevel:QRCode.CorrectLevel.M});
    }

    // 유틸/폼
    function buildQuestionRow(no,q){
      const w=document.createElement('div'); w.className='card';
      w.innerHTML=`
        <div class="row wrap">
          <div style="min-width:80px"><span class="badge">${no}번</span></div>
          <label class="switch"><input type="radio" name="type-${no}" value="mcq" ${(q?.type==='short')?'':'checked'}> 객관식</label>
          <label class="switch"><input type="radio" name="type-${no}" value="short" ${(q?.type==='short')?'checked':''}> 주관식</label>
        </div>
        <div class="row" style="margin-top:6px"><input class="q-text" data-no="${no}" placeholder="문항 내용" value="${esc(q?.text||'')}" style="flex:1"></div>
        <div class="mcq ${(q?.type==='short')?'hidden':''}" style="margin-top:8px">
          <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:8px">
            ${(q?.options||['','','','']).map((v,i)=>`<input class="opt" data-no="${no}" data-idx="${i}" placeholder="보기 ${i+1}" value="${esc(v)}">`).join('')}
          </div>
          <div class="row" style="margin-top:6px;gap:6px">
            <label>정답 번호</label>
            <input class="ansIndex" data-no="${no}" type="number" min="1" max="10" value="${(q?.answerIndex??0)+1}" style="width:90px">
          </div>
        </div>
        <div class="short ${(q?.type==='short')?'':'hidden'}" style="margin-top:8px">
          <input class="ansText" data-no="${no}" placeholder="정답(자동채점용, 선택)" value="${esc(q?.answerText||'')}" style="width:300px">
        </div>
      `;
      const radios=qsa(`input[name="type-${no}"]`,w); const mcq=qs('.mcq',w); const sh=qs('.short',w);
      radios.forEach(r=>r.onchange=()=>{ const isSh=radios.find(x=>x.checked)?.value==='short'; mcq.classList.toggle('hidden',isSh); sh.classList.toggle('hidden',!isSh); });
      return w;
    }
    function collectQuizFromBuilder(){
      const title=quizTitle.value||'퀴즈'; const cards=qsa('#builder>.card');
      const questions=cards.map((c,idx)=>{
        const no=idx+1; const type=c.querySelector(`input[name="type-${no}"]:checked`).value;
        const text=c.querySelector('.q-text').value.trim(); if(!text) return null;
        if(type==='mcq'){ const opts=qsa('.opt',c).map(x=>x.value.trim()).filter(Boolean);
          const ans=clamp(parseInt(c.querySelector('.ansIndex').value,10)-1,0,Math.max(0,opts.length-1));
          return {type:'mcq', text, options:opts, answerIndex:ans};
        } else {
          const at=c.querySelector('.ansText').value.trim(); return {type:'short', text, answerText:at};
        }
      }).filter(Boolean);
      return { title, questions };
    }

    // CSV/다운로드
    async function exportCSV(){
      if(!roomId) return;
      const r=(await getDoc(doc(db,'rooms',roomId))).data(); const res=await getDocs(collection(db,'rooms',roomId,'responses'));
      const rows=[]; rows.push(['userId','name',...(r.questions||[]).map((_,i)=>`Q${i+1}`),'score','status'].join(','));
      res.forEach(d=>{
        const v=d.data(); let score=0;
        const ans=(r.questions||[]).map((q,i)=>{ const a=v.answers?.[i]; if(a?.correct) score++; return csv(a?.value??''); });
        rows.push([d.id, csv(v.name), ...ans, score, v.status||''].join(','));
      });
      downloadFile(`${(r.title||roomId)}-results.csv`, rows.join('\n'));
    }
    function downloadFile(name,content,type='text/csv'){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

    // Helpers
    function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }
    function esc(s=''){ return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function csv(v){ const s=String(v??''); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }
    function formatMMSS(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }

    // URL 파라미터로 모드/세션 세팅(학생 접속용)
    (function bootByURL(){
      const p=new URLSearchParams(location.search);
      const m=p.get('mode'); const r=p.get('room');
      if(r){ roomIdInput.value=r; btnConnect.click(); }
      if(m==='student') setMode('student');
    })();

    // 초기 모드
    setMode('student');
  </script>
</body>
</html>
